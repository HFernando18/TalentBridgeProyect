<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de Universidad | Talent Bridge</title>

  <!-- Tailwind & Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <script src="https://kit.fontawesome.com/a2d5d5a92f.js" crossorigin="anonymous"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Poppins:wght@500;600&family=Open+Sans:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #00364d;
      --secondary: #e9a50e;
      --bg: #f9fafb;
      --text: #1f2937;
      --card: rgba(255,255,255,0.8);
      --card-border: rgba(255,255,255,0.4);
      --sidebar-bg: rgba(0, 54, 77, 0.9);
      --sidebar-br: rgba(255,255,255,0.1);
      --hero-grad-a: rgba(0,54,77,0.95);
      --hero-grad-b: rgba(0,54,77,0.85);
      --hero-grad-c: rgba(233,165,14,0.85);
      --progress-track: rgba(0,54,77,0.1);
    }
    .dark {
      --bg: #0b1220;
      --text: #e5e7eb;
      --card: rgba(16,23,42,0.7);
      --card-border: rgba(255,255,255,0.08);
      --sidebar-bg: rgba(3, 21, 32, 0.9);
      --sidebar-br: rgba(255,255,255,0.06);
      --hero-grad-a: rgba(2, 18, 30, 0.95);
      --hero-grad-b: rgba(3, 31, 49, 0.9);
      --hero-grad-c: rgba(233,165,14,0.8);
      --progress-track: rgba(255,255,255,0.08);
    }
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      overflow-x: hidden;
      position: relative;
    }
    /* Fondo animado */
    .animated-bg {
      position: fixed; inset: 0; z-index: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(233,165,14,0.05) 0%, transparent 60%),
        radial-gradient(circle at 80% 20%, rgba(0,54,77,0.06) 0%, transparent 60%);
      animation: moveBg 40s linear infinite alternate;
      pointer-events: none;
    }
    .dark .animated-bg {
      background:
        radial-gradient(circle at 20% 80%, rgba(233,165,14,0.08) 0%, transparent 60%),
        radial-gradient(circle at 80% 20%, rgba(0,54,77,0.1) 0%, transparent 60%);
    }
    @keyframes moveBg {
      0% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.05) rotate(180deg); }
      100% { transform: scale(1) rotate(360deg); }
    }
    /* Partículas */
    .particles { position: fixed; inset: 0; z-index: 1; overflow: hidden; pointer-events: none; }
    .particle { position: absolute; border-radius: 50%; opacity: 0.7; filter: blur(1px); animation: floatParticle linear infinite; }
    @keyframes floatParticle {
      0% { transform: translateY(0) translateX(0); opacity: 0.6; }
      50% { opacity: 1; }
      100% { transform: translateY(-100vh) translateX(20px); opacity: 0; }
    }
    /* Sidebar */
    .modern-sidebar {
      background: var(--sidebar-bg);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--sidebar-br);
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.3);
      position: relative; overflow: hidden; transition: all 0.4s ease;
    }
    .modern-sidebar::before {
      content: '';
      position: absolute; inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(233,165,14,0.06));
      background-size: 100% 200%;
      animation: gradientFlow 12s ease-in-out infinite alternate; z-index: 0;
    }
    @keyframes gradientFlow { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
    .modern-sidebar * { position: relative; z-index: 1; }
    .modern-sidebar nav a {
      display: flex; align-items: center; gap: 12px;
      padding: 0.9rem 1.2rem; border-radius: 0.9rem; font-weight: 500;
      color: rgba(255,255,255,0.85); transition: all 0.3s ease; position: relative; overflow: hidden;
    }
    .modern-sidebar nav a i { font-size: 1.1rem; color: rgba(255,255,255,0.8); transition: all 0.4s ease; }
    .modern-sidebar nav a span { font-family: 'Poppins', sans-serif; transition: all 0.3s ease; }
    .modern-sidebar nav a.active::before,
    .modern-sidebar nav a:hover::before {
      content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
      background: linear-gradient(180deg, var(--secondary), #fff);
      border-radius: 0 4px 4px 0; opacity: 0.9;
    }
    .modern-sidebar nav a:hover { background: rgba(255,255,255,0.1); color: white; transform: translateX(4px); }
    .modern-sidebar nav a:hover i { color: var(--secondary); transform: scale(1.1); }
    .modern-sidebar nav a.active { background: rgba(255,255,255,0.15); color: white; }
    /* Hero */
    .hero {
      background: linear-gradient(135deg, var(--hero-grad-a), var(--hero-grad-b) 40%, var(--hero-grad-c) 100%);
      color: white; position: relative; overflow: hidden; z-index: 2; border-radius: 1.25rem;
    }
    .hero::after {
      content: ""; position: absolute; top: -20%; left: -20%; width: 150%; height: 150%;
      background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.07) 0%, transparent 70%);
      animation: rotate 40s linear infinite;
    }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    /* Cards y progreso */
    .glass-card { background: var(--card); backdrop-filter: blur(20px); border: 1px solid var(--card-border); border-radius: 1.5rem; transition: all 0.3s ease; position: relative; z-index: 2; overflow: hidden; }
    .glass-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--secondary), var(--primary)); }
    .glass-card:hover { transform: translateY(-6px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
    .metric-value { font-family: 'Montserrat', sans-serif; font-weight: 800; letter-spacing: -0.02em; }
    .progress-bar { background: var(--progress-track); border-radius: 9999px; overflow: hidden; }
    .progress-bar-inner { background: linear-gradient(90deg, var(--secondary), var(--primary)); height: 8px; border-radius: 9999px; transition: width 0.4s ease; }
    /* Header */
    .header-blur { background: rgba(255,255,255,0.8); }
    .dark .header-blur { background: rgba(2, 8, 23, 0.6); }

    .badge { font-size:.65rem; letter-spacing:.03em; }
    .table-mini th, .table-mini td { padding:.6rem .75rem; font-size:.9rem; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; border-radius:.75rem; padding:.5rem .75rem; font-weight:600;}
  </style>
</head>

<body class="min-h-screen flex">
  <div class="animated-bg"></div>
  <div class="particles" id="particles"></div>

  <!-- Sidebar -->
  <aside
    id="sidebar"
    class="modern-sidebar fixed inset-y-0 left-0 w-72 flex flex-col justify-between z-[70]
           transform transition-transform duration-300 ease-out
           -translate-x-full md:translate-x-0"
    aria-hidden="true"
    aria-label="Navegación principal"
  >
    <div class="px-6 py-8 flex flex-col h-full">
      <!-- Header móvil con botón cerrar -->
      <div class="md:hidden flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <img src="img/logo/Talent_Bridge_FH_Final.svg" alt="Talent Bridge" class="h-8 w-auto">
          <span class="text-white font-semibold">Menú</span>
        </div>
        <button id="closeSidebar" class="text-white/80 hover:text-white text-2xl" aria-label="Cerrar menú">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <!-- Logo (desktop) -->
      <div class="hidden md:flex items-center gap-3 mb-6 border-b border-white/10 pb-4">
        <img src="img/logo/Talent_Bridge_FH_Final.svg" alt="Talent Bridge" class="h-10 w-auto">
        <h2 class="font-montserrat text-lg font-extrabold text-white tracking-wide">Talent Bridge</h2>
      </div>

      <!-- Avatar y datos -->
      <div class="flex flex-col items-center text-center mb-8">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Avatar" class="w-16 h-16 rounded-full border-2 border-white/40 mb-2">
        <h3 id="navUniName" class="text-white font-semibold text-lg"></h3>
        <p id="navUniEmail" class="text-white/70 text-sm"></p>
      </div>

      <!-- Navegación -->
      <nav id="sideNav" class="flex-1 flex flex-col gap-1">
        <a href="#/inicio"        data-route="#/inicio" class="active"><i class="fa-solid fa-house"></i><span>Inicio</span></a>
        <a href="#/vacantes"      data-route="#/vacantes"><i class="fa-solid fa-bullhorn"></i><span>Vacantes</span></a>
        <a href="#/postulaciones" data-route="#/postulaciones"><i class="fa-solid fa-inbox"></i><span>Postulaciones</span></a>
        <a href="#/seguimiento"   data-route="#/seguimiento"><i class="fa-solid fa-user-graduate"></i><span>Seguimiento</span></a>
        <a href="#/metricas"      data-route="#/metricas"><i class="fa-solid fa-chart-line"></i><span>Métricas</span></a>
        <a href="#/convenios"     data-route="#/convenios"><i class="fa-solid fa-handshake"></i><span>Convenios</span></a>
        <a href="#/perfil"        data-route="#/perfil"><i class="fa-solid fa-building-columns"></i><span>Perfil</span></a>
      </nav>
    </div>

    <div class="p-6 border-t border-white/10 flex items-center justify-end">
      <button id="logout" class="bg-gradient-to-r from-[var(--secondary)] to-yellow-400 text-[var(--primary)] font-semibold py-2 px-4 rounded-xl hover:shadow-md transition-all flex items-center gap-2">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span>Cerrar sesión</span>
      </button>
    </div>
  </aside>

  <!-- Overlay móvil -->
  <div
    id="sidebarOverlay"
    class="fixed inset-0 bg-black/40 backdrop-blur-md opacity-0 pointer-events-none hidden transition-opacity duration-300 z-[60] md:hidden"
  ></div>

  <!-- Contenido principal -->
  <div class="flex-1 md:ml-72 flex flex-col relative z-10">
    <header class="header-blur backdrop-blur sticky top-0 z-50 border-b border-gray-200 dark:border-white/10 p-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <button
          id="menuBtn"
          class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-full
                 text-[var(--primary)] dark:text-white ring-1 ring-inset ring-gray-300/70 dark:ring-white/10
                 bg-white/80 dark:bg-slate-800/70"
          aria-label="Abrir menú"
          aria-controls="sidebar"
          aria-expanded="false"
          type="button"
        >
          <!-- Hamburguesa SVG confiable -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
               width="22" height="22" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
               aria-hidden="true" focusable="false">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>

        <h1 class="text-xl font-montserrat font-extrabold tracking-tight text-[var(--primary)] dark:text-white">
          <span id="headerTitle">Panel de Universidad</span>
        </h1>
      </div>

      <div class="flex items-center gap-3">
        <button
          id="themeToggle"
          type="button"
          aria-label="Cambiar tema"
          aria-pressed="false"
          class="relative inline-flex items-center justify-center w-10 h-10 rounded-full
                 ring-1 ring-inset ring-gray-200 dark:ring-white/10 bg-white/70 dark:bg-slate-800/70
                 transition hover:scale-105 focus:outline-none focus-visible:ring-2
                 focus-visible:ring-offset-2 focus-visible:ring-[var(--secondary)]"
        >
          <!-- Sol -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
               class="w-5 h-5 text-yellow-400 dark:hidden" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="4"></circle>
            <line x1="12" y1="2" x2="12" y2="4"></line>
            <line x1="12" y1="20" x2="12" y2="22"></line>
            <line x1="4.93" y1="4.93" x2="6.34" y2="6.34"></line>
            <line x1="17.66" y1="17.66" x2="19.07" y2="19.07"></line>
            <line x1="2" y1="12" x2="4" y2="12"></line>
            <line x1="20" y1="12" x2="22" y2="12"></line>
            <line x1="4.93" y1="19.07" x2="6.34" y2="17.66"></line>
            <line x1="17.66" y1="6.34" x2="19.07" y2="4.93"></line>
          </svg>
          <!-- Luna -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
               class="w-5 h-5 text-yellow-300 hidden dark:inline" fill="currentColor">
            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- SPA -->
    <main id="app" class="p-8 space-y-12"></main>
  </div>

  <!-- Modal Crear/Editar Vacante -->
  <div id="vacModal" class="fixed inset-0 z-[85] hidden">
    <div id="vacModalOverlay" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="relative z-[86] max-w-xl mx-auto mt-16 p-6 rounded-2xl border border-white/10 bg-white/95 dark:bg-slate-900/85">
      <div class="flex items-start justify-between gap-4">
        <h3 id="vacModalTitle" class="text-xl font-montserrat font-extrabold text-[var(--primary)] dark:text-white">Nueva vacante</h3>
        <button id="vacModalClose" class="text-gray-600 dark:text-gray-300 hover:opacity-80">
          <i class="fa-solid fa-xmark text-2xl"></i>
        </button>
      </div>
      <div class="mt-4 grid gap-3">
        <input id="vacCargo" class="rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" placeholder="Cargo (p. ej. Pasante de Datos)" />
        <input id="vacEmpresa" class="rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" placeholder="Empresa (p. ej. Banco Pichincha)" />
        <div class="grid grid-cols-2 gap-3">
          <input id="vacCiudad" class="rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" placeholder="Ciudad" />
          <select id="vacModalidad" class="rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3">
            <option value="Presencial">Presencial</option>
            <option value="Híbrido">Híbrido</option>
            <option value="Remoto">Remoto</option>
          </select>
        </div>
        <input id="vacCarreras" class="rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" placeholder="Carreras objetivo (separa por coma)" />
        <input id="vacTags" class="rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" placeholder="Tags/Habilidades (separa por coma)" />
        <textarea id="vacDesc" rows="4" class="rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" placeholder="Descripción breve"></textarea>
      </div>
      <div class="mt-5 flex gap-3 justify-end">
        <button id="vacModalCancel" class="btn border border-gray-300 dark:border-white/20 text-gray-800 dark:text-gray-200">Cancelar</button>
        <button id="vacModalSave" class="btn bg-[var(--primary)] text-white">Guardar</button>
      </div>
      <input type="hidden" id="vacEditId" />
    </div>
  </div>

  <script>
    // === Preferencia inicial del tema ===
    (function initTheme(){
      const stored = localStorage.getItem('tb-theme');
      const systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initialDark = stored ? stored === 'dark' : systemPrefersDark;
      document.documentElement.classList.toggle('dark', initialDark);
      queueMicrotask(() => {
        const t = document.getElementById('themeToggle');
        if (t) {
          t.setAttribute('aria-pressed', String(initialDark));
          t.setAttribute('aria-label', initialDark ? 'Cambiar a tema claro' : 'Cambiar a tema oscuro');
        }
      });
    })();

    // === Seguridad: solo universidades ===
    window.usuario = JSON.parse(localStorage.getItem("usuarioActivo"));
    if (!window.usuario || window.usuario.tipo !== "universidad") {
      window.location.href = "login.html";
    } else {
      document.getElementById("navUniName").textContent = window.usuario.nombre || "Universidad";
      document.getElementById("navUniEmail").textContent = window.usuario.email || "correo@universidad.edu.ec";
    }

    // --- Sidebar responsive ---
    const menuBtn = document.getElementById("menuBtn");
    const sidebar = document.getElementById("sidebar");
    const closeSidebarBtn = document.getElementById("closeSidebar");
    const overlay = document.getElementById("sidebarOverlay");

    let sidebarOpen = false;
    function openSidebar() {
      sidebar.classList.remove("-translate-x-full");
      overlay.classList.remove("hidden", "pointer-events-none", "opacity-0");
      overlay.classList.add("opacity-100");
      sidebar.setAttribute("aria-hidden", "false");
      sidebarOpen = true;
      document.body.style.overflow = "hidden";
      menuBtn?.setAttribute("aria-expanded", "true");
    }
    function closeSidebar() {
      sidebar.classList.add("-translate-x-full");
      overlay.classList.remove("opacity-100");
      overlay.classList.add("opacity-0");
      const onFadeEnd = () => {
        overlay.classList.add("hidden", "pointer-events-none");
        overlay.removeEventListener("transitionend", onFadeEnd);
      };
      overlay.addEventListener("transitionend", onFadeEnd, { once: true });
      sidebar.setAttribute("aria-hidden", "true");
      sidebarOpen = false;
      document.body.style.overflow = "";
      menuBtn?.setAttribute("aria-expanded", "false");
    }
    menuBtn?.addEventListener("click", () => {
      if (window.matchMedia("(min-width: 768px)").matches) return;
      sidebarOpen ? closeSidebar() : openSidebar();
    });
    closeSidebarBtn?.addEventListener("click", closeSidebar);
    overlay?.addEventListener("click", closeSidebar);
    document.addEventListener("keydown", (e) => { if (e.key === "Escape" && sidebarOpen) closeSidebar(); });

    const mqMd = window.matchMedia("(min-width: 768px)");
    mqMd.addEventListener?.("change", (e) => {
      if (e.matches) {
        sidebar.classList.remove("-translate-x-full");
        overlay.classList.add("hidden", "pointer-events-none", "opacity-0");
        overlay.classList.remove("opacity-100");
        sidebarOpen = false;
        document.body.style.overflow = "";
        menuBtn?.setAttribute("aria-expanded", "false");
      } else {
        sidebar.classList.add("-translate-x-full");
        overlay.classList.add("hidden", "pointer-events-none", "opacity-0");
        overlay.classList.remove("opacity-100");
        sidebarOpen = false;
        document.body.style.overflow = "";
        menuBtn?.setAttribute("aria-expanded", "false");
      }
    });

    // Partículas
    const particleContainer = document.getElementById("particles");
    for (let i = 0; i < 28; i++) {
      const p = document.createElement("div");
      p.classList.add("particle");
      const size = Math.random() * 4 + 2;
      const duration = Math.random() * 10 + 15;
      const delay = Math.random() * 10;
      const left = Math.random() * 100;
      const color = Math.random() > 0.5 ? "rgba(233,165,14,0.9)" : (document.documentElement.classList.contains('dark') ? "rgba(150,200,255,0.7)" : "rgba(0,160,255,0.8)");
      p.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;
      p.style.width = `${size}px`; p.style.height = `${size}px`;
      p.style.left = `${left}%`;
      p.style.bottom = `-${Math.random() * 20}px`;
      p.style.animationDuration = `${duration}s`;
      p.style.animationDelay = `${delay}s`;
      particleContainer.appendChild(p);
    }

    // Toggle tema
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('tb-theme', isDark ? 'dark' : 'light');
      themeToggle.setAttribute('aria-pressed', String(isDark));
      themeToggle.setAttribute('aria-label', isDark ? 'Cambiar a tema claro' : 'Cambiar a tema oscuro');
    });
    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    mq.addEventListener?.('change', e => {
      if (!localStorage.getItem('tb-theme')) {
        document.documentElement.classList.toggle('dark', e.matches);
        themeToggle.setAttribute('aria-pressed', String(e.matches));
        themeToggle.setAttribute('aria-label', e.matches ? 'Cambiar a tema claro' : 'Cambiar a tema oscuro');
      }
    });

    // ===== Helpers clave por universidad =====
    function uniKey(suffix){
      const id = window.usuario?.email || window.usuario?.nombre || 'default';
      return `uni_${id}_${suffix}`;
    }
    function loadJSON(key, def){ try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); } catch { return def; } }
    function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    // ===== Seeds (si vacío) =====
    function seedIfNeeded(){
      const vac = loadJSON(uniKey('vacantes'), null);
      if (!vac) {
        const initial = [
          { id:'v1', cargo:'Pasante de Datos', empresa:'Banco Pichincha', ciudad:'Quito', modalidad:'Remoto', carreras:['Datos','Sistemas'], tags:['SQL','Power BI','Python'], desc:'Apoyo en dashboards e indicadores', estado:'Activa', fecha: Date.now()-86400000*10 },
          { id:'v2', cargo:'Front-end Intern', empresa:'Kruger', ciudad:'Quito', modalidad:'Híbrido', carreras:['Software','Sistemas'], tags:['React','Tailwind'], desc:'Soporte UI para proyectos', estado:'Activa', fecha: Date.now()-86400000*7 },
        ];
        saveJSON(uniKey('vacantes'), initial);
      }
      const posts = loadJSON(uniKey('postulaciones'), null);
      if (!posts) {
        const initialP = [
          { id:'p1', vacanteId:'v1', estudiante:'María López', carrera:'Datos', fecha: Date.now()-86400000*3, estado:'Pendiente', email:'maria@uni.edu' },
          { id:'p2', vacanteId:'v2', estudiante:'Juan Pérez', carrera:'Software', fecha: Date.now()-86400000*2, estado:'Pendiente', email:'juan@uni.edu' },
        ];
        saveJSON(uniKey('postulaciones'), initialP);
      }
      const seg = loadJSON(uniKey('seguimiento'), null);
      if (!seg) {
        const initialS = [
          { id:'s1', estudiante:'María López', carrera:'Datos', empresa:'Banco Pichincha', cargo:'Pasante de Datos', estado:'En curso', horas: 120, metaHoras: 240, tutor:'Ing. Viteri', inicio:'2025-02-01', fin:'2025-06-30' },
          { id:'s2', estudiante:'Juan Pérez', carrera:'Software', empresa:'Kruger', cargo:'Front-end Intern', estado:'En curso', horas: 80, metaHoras: 240, tutor:'Ing. Almeida', inicio:'2025-02-10', fin:'2025-07-10' },
        ];
        saveJSON(uniKey('seguimiento'), initialS);
      }
      const conv = loadJSON(uniKey('convenios'), null);
      if (!conv) {
        const initialC = [
          { id:'c1', empresa:'Banco Pichincha', tipo:'Marco', vigente:true, desde:'2024-01-01', hasta:'2026-12-31' },
          { id:'c2', empresa:'Kruger', tipo:'Específico', vigente:true, desde:'2025-01-15', hasta:'2026-01-15' },
          { id:'c3', empresa:'Telconet', tipo:'Marco', vigente:false, desde:'2022-05-01', hasta:'2024-05-01' },
        ];
        saveJSON(uniKey('convenios'), initialC);
      }
    }
    seedIfNeeded();

    // ====== COMPONENTES ======
    const app = document.getElementById('app');
    const headerTitleEl = document.getElementById('headerTitle');
    const sideNav = document.getElementById('sideNav');

    const Card = ({title, body, classes=""}) => `
      <section class="bg-white/90 dark:bg-slate-900/60 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-white/10 ${classes}">
        ${title ? `<h3 class="font-poppins text-xl md:text-2xl font-semibold text-[var(--primary)] dark:text-white mb-4">${title}</h3>` : ""}
        ${body || ""}
      </section>
    `;

    // ====== VISTAS ======
    const viewInicio = () => {
      const vac = loadJSON(uniKey('vacantes'), []);
      const seg = loadJSON(uniKey('seguimiento'), []);
      const posts = loadJSON(uniKey('postulaciones'), []);
      const activas = vac.filter(v=>v.estado==='Activa').length;
      const enCurso = seg.filter(s=>s.estado==='En curso').length;
      const pendientes = posts.filter(p=>p.estado==='Pendiente').length;

      return `
        <section class="hero p-10 md:p-16 text-center">
          <h2 class="text-3xl md:text-5xl font-montserrat font-extrabold mb-3">
            Bienvenida, ${window.usuario?.nombre || 'Universidad'}
          </h2>
          <p class="max-w-2xl mx-auto text-white/90 text-lg">Administra convenios, vacantes y el progreso de tus estudiantes desde un solo lugar.</p>
          <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
            <a href="#/vacantes" class="bg-white text-[var(--primary)] font-semibold px-8 py-3 rounded-full shadow hover:bg-opacity-90 transition">
              <i class="fa-solid fa-bullhorn"></i> Crear Vacante
            </a>
            <a href="#/seguimiento" class="border border-white/40 text-white px-8 py-3 rounded-full font-semibold hover:bg-white/10 transition">
              <i class="fa-solid fa-user-graduate"></i> Ver Seguimiento
            </a>
          </div>
        </section>

        <section>
          <h3 class="text-2xl font-poppins font-semibold text-[var(--primary)] dark:text-white mb-6">Resumen</h3>
          <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="glass-card p-8 text-center">
              <div class="text-5xl text-[var(--secondary)] mb-3"><i class="fa-solid fa-bullhorn"></i></div>
              <h4 class="font-semibold text-[var(--primary)] dark:text-white mb-1">Vacantes Activas</h4>
              <p class="metric-value text-4xl">${activas}</p>
            </div>
            <div class="glass-card p-8 text-center">
              <div class="text-5xl text-[var(--primary)] dark:text-[var(--secondary)] mb-3"><i class="fa-solid fa-inbox"></i></div>
              <h4 class="font-semibold text-[var(--primary)] dark:text-white mb-1">Postulaciones Pendientes</h4>
              <p class="metric-value text-4xl">${pendientes}</p>
            </div>
            <div class="glass-card p-8 text-center">
              <div class="text-5xl text-[var(--secondary)] mb-3"><i class="fa-solid fa-user-graduate"></i></div>
              <h4 class="font-semibold text-[var(--primary)] dark:text-white mb-1">Estudiantes en Curso</h4>
              <p class="metric-value text-4xl">${enCurso}</p>
            </div>
            <div class="glass-card p-8 text-center">
              <div class="text-5xl text-[var(--primary)] dark:text-[var(--secondary)] mb-3"><i class="fa-solid fa-handshake"></i></div>
              <h4 class="font-semibold text-[var(--primary)] dark:text-white mb-1">Convenios Vigentes</h4>
              <p class="metric-value text-4xl">${loadJSON(uniKey('convenios'), []).filter(c=>c.vigente).length}</p>
            </div>
          </div>
        </section>
      `;
    };

    const viewVacantes = () => {
      const vac = loadJSON(uniKey('vacantes'), []);
      const rows = vac.map(v => `
        <tr class="border-b border-gray-100 dark:border-white/10">
          <td>${v.cargo}<div class="text-xs text-gray-500">${v.empresa} · ${v.modalidad} · ${v.ciudad}</div></td>
          <td class="hidden md:table-cell">${(v.carreras||[]).join(', ')}</td>
          <td class="hidden md:table-cell">${(v.tags||[]).join(', ')}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs ${v.estado==='Activa' ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200' : 'bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-200'}">
              ${v.estado}
            </span>
          </td>
          <td class="text-right space-x-2">
            <button class="btn border border-gray-300 dark:border-white/20" data-edit="${v.id}"><i class="fa-solid fa-pen"></i> Editar</button>
            <button class="btn ${v.estado==='Activa'?'bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-200':'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200'}" data-toggle="${v.id}">
              ${v.estado==='Activa'?'Pausar':'Activar'}
            </button>
            <button class="btn text-red-600 border border-red-200 dark:border-red-800" data-del="${v.id}"><i class="fa-solid fa-trash"></i> Eliminar</button>
          </td>
        </tr>
      `).join('');

      return `
        ${Card({
          title: "Vacantes publicadas",
          body: `
            <div class="mb-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
              <div class="flex gap-2">
                <button id="btnNewVac" class="btn bg-[var(--primary)] text-white"><i class="fa-solid fa-plus"></i> Nueva vacante</button>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-300">Total: <strong>${vac.length}</strong></p>
            </div>

            <div class="overflow-x-auto rounded-xl border border-gray-100 dark:border-white/10">
              <table class="w-full table-mini">
                <thead class="bg-white/60 dark:bg-slate-800/50">
                  <tr class="text-left">
                    <th>Cargo</th>
                    <th class="hidden md:table-cell">Carreras</th>
                    <th class="hidden md:table-cell">Tags</th>
                    <th>Estado</th>
                    <th class="text-right">Acciones</th>
                  </tr>
                </thead>
                <tbody class="bg-white/40 dark:bg-slate-900/40">${rows || ''}</tbody>
              </table>
            </div>
          `
        })}
      `;
    };

    const viewPostulaciones = () => {
      const posts = loadJSON(uniKey('postulaciones'), []);
      const vac = loadJSON(uniKey('vacantes'), []);
      const vMap = Object.fromEntries(vac.map(v=>[v.id, v]));
      const rows = posts.map(p => `
        <tr class="border-b border-gray-100 dark:border-white/10">
          <td class="font-medium">${p.estudiante}<div class="text-xs text-gray-500">${p.email}</div></td>
          <td>${p.carrera}</td>
          <td>${vMap[p.vacanteId]?.cargo || '—'}<div class="text-xs text-gray-500">${vMap[p.vacanteId]?.empresa || ''}</div></td>
          <td>${new Date(p.fecha).toLocaleDateString()}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs ${p.estado==='Pendiente' ? 'bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-gray-200': p.estado==='Aprobada' ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200' : 'bg-rose-100 text-rose-800 dark:bg-rose-900/40 dark:text-rose-200'}">
              ${p.estado}
            </span>
          </td>
          <td class="text-right space-x-2">
            <button class="btn bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200" data-approve="${p.id}"><i class="fa-solid fa-check"></i> Aprobar</button>
            <button class="btn bg-rose-100 text-rose-800 dark:bg-rose-900/40 dark:text-rose-200" data-reject="${p.id}"><i class="fa-solid fa-xmark"></i> Rechazar</button>
          </td>
        </tr>
      `).join('');

      return `
        ${Card({
          title: "Postulaciones recibidas",
          body: `
            <div class="overflow-x-auto rounded-xl border border-gray-100 dark:border-white/10">
              <table class="w-full table-mini">
                <thead class="bg-white/60 dark:bg-slate-800/50">
                  <tr class="text-left">
                    <th>Estudiante</th><th>Carrera</th><th>Vacante</th><th>Fecha</th><th>Estado</th><th class="text-right">Acciones</th>
                  </tr>
                </thead>
                <tbody class="bg-white/40 dark:bg-slate-900/40">${rows || ''}</tbody>
              </table>
            </div>
          `
        })}
      `;
    };

    const viewSeguimiento = () => {
      const seg = loadJSON(uniKey('seguimiento'), []);
      const rows = seg.map(s => {
        const pct = Math.min(100, Math.round((s.horas / (s.metaHoras||1)) * 100));
        return `
          <tr class="border-b border-gray-100 dark:border-white/10">
            <td class="font-medium">${s.estudiante}<div class="text-xs text-gray-500">${s.carrera}</div></td>
            <td>${s.empresa}<div class="text-xs text-gray-500">${s.cargo}</div></td>
            <td>
              <div class="progress-bar w-40"><div class="progress-bar-inner" style="width:${pct}%"></div></div>
              <div class="text-xs text-gray-500 mt-1">${s.horas}/${s.metaHoras} h</div>
            </td>
            <td>${s.tutor}</td>
            <td>${s.inicio} → ${s.fin}</td>
            <td>
              <select data-state="${s.id}" class="rounded-lg bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 px-2 py-1">
                ${['En curso','Aprobada','Reprobada','Finalizada'].map(st => `<option value="${st}" ${st===s.estado?'selected':''}>${st}</option>`).join('')}
              </select>
            </td>
            <td class="text-right space-x-2">
              <button class="btn border border-gray-300 dark:border-white/20" data-addh="${s.id}"><i class="fa-solid fa-plus"></i> Horas</button>
              <button class="btn text-red-600 border border-red-200 dark:border-red-800" data-dels="${s.id}"><i class="fa-solid fa-trash"></i></button>
            </td>
          </tr>
        `;
      }).join('');

      return `
        ${Card({
          title: "Seguimiento de estudiantes",
          body: `
            <div class="mb-3 flex gap-2">
              <button id="btnAddSeg" class="btn bg-[var(--primary)] text-white"><i class="fa-solid fa-user-plus"></i> Agregar estudiante</button>
              <button id="btnExpCSV" class="btn border border-gray-300 dark:border-white/20"><i class="fa-solid fa-file-export"></i> Exportar CSV</button>
            </div>
            <div class="overflow-x-auto rounded-xl border border-gray-100 dark:border-white/10">
              <table class="w-full table-mini">
                <thead class="bg-white/60 dark:bg-slate-800/50">
                  <tr class="text-left">
                    <th>Estudiante</th><th>Empresa</th><th>Horas</th><th>Tutor</th><th>Fechas</th><th>Estado</th><th class="text-right">Acciones</th>
                  </tr>
                </thead>
                <tbody class="bg-white/40 dark:bg-slate-900/40">${rows || ''}</tbody>
              </table>
            </div>
          `
        })}
      `;
    };

    const viewMetricas = () => {
      const seg = loadJSON(uniKey('seguimiento'), []);
      const vac = loadJSON(uniKey('vacantes'), []);
      const posts = loadJSON(uniKey('postulaciones'), []);
      const totalHoras = seg.reduce((a,s)=>a + (s.horas||0), 0);
      const finalizadas = seg.filter(s=>s.estado==='Finalizada' || s.estado==='Aprobada').length;
      const tasaAprob = posts.length ? Math.round((posts.filter(p=>p.estado==='Aprobada').length / posts.length) * 100) : 0;
      const porCarrera = {};
      seg.forEach(s => { porCarrera[s.carrera] = (porCarrera[s.carrera]||0) + 1; });
      const carreraBars = Object.entries(porCarrera).map(([c,n]) => `
        <div>
          <div class="flex justify-between text-sm"><span>${c}</span><span>${n}</span></div>
          <div class="progress-bar"><div class="progress-bar-inner" style="width:${Math.min(100, n*20)}%"></div></div>
        </div>
      `).join('');

      return `
        <div class="grid lg:grid-cols-2 gap-6">
          ${Card({
            title:"Indicadores clave",
            body: `
              <div class="grid sm:grid-cols-2 gap-4">
                <div class="glass-card p-6">
                  <div class="text-4xl text-[var(--secondary)] mb-2"><i class="fa-solid fa-hourglass-half"></i></div>
                  <p class="text-sm text-gray-600 dark:text-gray-300">Horas acumuladas</p>
                  <p class="metric-value text-3xl">${totalHoras}</p>
                </div>
                <div class="glass-card p-6">
                  <div class="text-4xl text-[var(--primary)] dark:text-[var(--secondary)] mb-2"><i class="fa-solid fa-check-circle"></i></div>
                  <p class="text-sm text-gray-600 dark:text-gray-300">Prácticas finalizadas/aprobadas</p>
                  <p class="metric-value text-3xl">${finalizadas}</p>
                </div>
                <div class="glass-card p-6">
                  <div class="text-4xl text-[var(--secondary)] mb-2"><i class="fa-solid fa-inbox"></i></div>
                  <p class="text-sm text-gray-600 dark:text-gray-300">Postulaciones</p>
                  <p class="metric-value text-3xl">${posts.length}</p>
                </div>
                <div class="glass-card p-6">
                  <div class="text-4xl text-[var(--primary)] dark:text-[var(--secondary)] mb-2"><i class="fa-solid fa-bullhorn"></i></div>
                  <p class="text-sm text-gray-600 dark:text-gray-300">Vacantes activas</p>
                  <p class="metric-value text-3xl">${vac.filter(v=>v.estado==='Activa').length}</p>
                </div>
              </div>
              <div class="mt-6">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Tasa de aprobación de postulaciones</p>
                <div class="progress-bar"><div class="progress-bar-inner" style="width:${tasaAprob}%"></div></div>
                <p class="text-xs text-gray-500 mt-1">${tasaAprob}%</p>
              </div>
            `
          })}
          ${Card({
            title:"Distribución por carrera (estudiantes en seguimiento)",
            body: `
              <div class="space-y-3">${carreraBars || '<p class="text-sm text-gray-600 dark:text-gray-300">Sin datos</p>'}</div>
            `
          })}
        </div>
      `;
    };

    const viewConvenios = () => {
      const conv = loadJSON(uniKey('convenios'), []);
      const rows = conv.map(c => `
        <tr class="border-b border-gray-100 dark:border-white/10">
          <td class="font-medium">${c.empresa}</td>
          <td>${c.tipo}</td>
          <td>${c.desde}</td>
          <td>${c.hasta}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs ${c.vigente?'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200':'bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-gray-200'}">
              ${c.vigente ? 'Vigente' : 'Vencido'}
            </span>
          </td>
          <td class="text-right">
            <button class="btn border border-gray-300 dark:border-white/20" data-togglec="${c.id}">${c.vigente?'Marcar vencido':'Marcar vigente'}</button>
            <button class="btn text-red-600 border border-red-200 dark:border-red-800" data-delc="${c.id}"><i class="fa-solid fa-trash"></i></button>
          </td>
        </tr>
      `).join('');

      return `
        ${Card({
          title: "Convenios con empresas",
          body: `
            <div class="mb-3 flex gap-2">
              <button id="btnAddConv" class="btn bg-[var(--primary)] text-white"><i class="fa-solid fa-plus"></i> Nuevo convenio</button>
            </div>
            <div class="overflow-x-auto rounded-xl border border-gray-100 dark:border-white/10">
              <table class="w-full table-mini">
                <thead class="bg-white/60 dark:bg-slate-800/50">
                  <tr class="text-left">
                    <th>Empresa</th><th>Tipo</th><th>Desde</th><th>Hasta</th><th>Estado</th><th class="text-right">Acciones</th>
                  </tr>
                </thead>
                <tbody class="bg-white/40 dark:bg-slate-900/40">${rows || ''}</tbody>
              </table>
            </div>
          `
        })}
      `;
    };

    const viewPerfil = () => {
      return `
        ${Card({
          title: "Perfil de la Universidad",
          body: `
            <form class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Nombre de la Universidad</label>
                <input id="inpNombreU" class="w-full rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" />
              </div>
              <div>
                <label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Correo de contacto</label>
                <input id="inpEmailU" type="email" class="w-full rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Sitio web</label>
                <input id="inpWebU" placeholder="https://www.tu-universidad.edu" class="w-full rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" />
              </div>
              <div class="md:col-span-2 flex gap-2">
                <button type="button" id="btnGuardarPerfilU" class="px-4 py-2 rounded-xl bg-[var(--primary)] text-white">Guardar</button>
                <button type="button" id="btnCancelarPerfilU" class="px-4 py-2 rounded-xl border border-[var(--primary)] text-[var(--primary)] dark:border-white dark:text-white">Cancelar</button>
              </div>
            </form>
          `
        })}

        ${Card({
          title: "Credenciales (opcional)",
          body: `
            <div class="grid md:grid-cols-3 gap-3">
              <div>
                <label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Nueva contraseña</label>
                <input id="inpPass1" type="password" autocomplete="new-password" placeholder="********" class="w-full rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" />
              </div>
              <div>
                <label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Confirmar contraseña</label>
                <input id="inpPass2" type="password" autocomplete="new-password" placeholder="********" class="w-full rounded-xl bg-white/70 dark:bg-slate-800/60 border border-gray-200 dark:border-white/10 p-3" />
              </div>
              <div class="flex items-end">
                <button id="btnCambiarPass" class="w-full px-4 py-2 rounded-xl bg-amber-400 text-[var(--primary)] font-bold">Actualizar</button>
              </div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Para cumplir con buenas prácticas de accesibilidad, los campos tienen <code>autocomplete="new-password"</code>.</p>
          `
        })}
      `;
    };

    // ===== RUTAS =====
    const routes = {
      '#/inicio':        { title: 'Panel de Universidad', render: viewInicio },
      '#/vacantes':      { title: 'Vacantes',             render: viewVacantes },
      '#/postulaciones': { title: 'Postulaciones',        render: viewPostulaciones },
      '#/seguimiento':   { title: 'Seguimiento',          render: viewSeguimiento },
      '#/metricas':      { title: 'Métricas',             render: viewMetricas },
      '#/convenios':     { title: 'Convenios',            render: viewConvenios },
      '#/perfil':        { title: 'Perfil',               render: viewPerfil },
    };

    function setActiveLink(hash) {
      const links = sideNav.querySelectorAll('a[data-route]');
      links.forEach(a => a.classList.toggle('active', a.getAttribute('data-route') === hash));
    }
    function closeSidebarIfMobile() {
      if (window.matchMedia("(max-width: 767px)").matches) closeSidebar();
    }

    // ===== Router principal =====
    function router() {
      const hash = location.hash || '#/inicio';
      const route = routes[hash] || routes['#/inicio'];
      headerTitleEl.textContent = route.title;
      app.innerHTML = route.render();

      // VACANTES handlers
      if (hash === '#/vacantes') {
        document.getElementById('btnNewVac').onclick = () => openVacModal();
        const tbody = app.querySelector('tbody');
        tbody?.addEventListener('click', (e) => {
          const btnT = e.target.closest('button[data-toggle]');
          const btnE = e.target.closest('button[data-edit]');
          const btnD = e.target.closest('button[data-del]');
          if (btnT) {
            const id = btnT.getAttribute('data-toggle');
            const vac = loadJSON(uniKey('vacantes'), []);
            const v = vac.find(x=>x.id===id);
            if (v){ v.estado = v.estado==='Activa'?'Pausada':'Activa'; saveJSON(uniKey('vacantes'), vac); router(); }
          }
          if (btnE) {
            const id = btnE.getAttribute('data-edit');
            const vac = loadJSON(uniKey('vacantes'), []);
            const v = vac.find(x=>x.id===id);
            if (v) openVacModal(v);
          }
          if (btnD) {
            const id = btnD.getAttribute('data-del');
            if (!confirm('¿Eliminar esta vacante?')) return;
            const vac = loadJSON(uniKey('vacantes'), []).filter(x=>x.id!==id);
            saveJSON(uniKey('vacantes'), vac); router();
          }
        });
      }

      // POSTULACIONES handlers
      if (hash === '#/postulaciones') {
        const tbody = app.querySelector('tbody');
        tbody?.addEventListener('click', (e) => {
          const btnA = e.target.closest('button[data-approve]');
          const btnR = e.target.closest('button[data-reject]');
          if (!btnA && !btnR) return;
          const id = (btnA||btnR).getAttribute(btnA?'data-approve':'data-reject');
          const posts = loadJSON(uniKey('postulaciones'), []);
          const p = posts.find(x=>x.id===id);
          if (p) { p.estado = btnA ? 'Aprobada' : 'Rechazada'; saveJSON(uniKey('postulaciones'), posts); router(); }
        });
      }

      // SEGUIMIENTO handlers
      if (hash === '#/seguimiento') {
        document.getElementById('btnAddSeg').onclick = () => {
          const estudiante = prompt('Nombre del estudiante:'); if(!estudiante) return;
          const carrera = prompt('Carrera:') || '';
          const empresa = prompt('Empresa:') || '';
          const cargo = prompt('Cargo:') || '';
          const tutor = prompt('Tutor académico:') || '';
          const metaHoras = parseInt(prompt('Meta de horas (ej. 240):')||'240',10);
          const inicio = prompt('Fecha inicio (YYYY-MM-DD):') || '';
          const fin = prompt('Fecha fin (YYYY-MM-DD):') || '';
          const seg = loadJSON(uniKey('seguimiento'), []);
          seg.unshift({ id: crypto.randomUUID?.()||String(Date.now()), estudiante, carrera, empresa, cargo, estado:'En curso', horas:0, metaHoras, tutor, inicio, fin });
          saveJSON(uniKey('seguimiento'), seg); router();
        };
        document.getElementById('btnExpCSV').onclick = () => exportSeguimientoCSV();

        const tbody = app.querySelector('tbody');
        tbody?.addEventListener('click', (e) => {
          const btnH = e.target.closest('button[data-addh]');
          const btnDel = e.target.closest('button[data-dels]');
          const selSt = e.target.closest('select[data-state]');
          if (btnH) {
            const id = btnH.getAttribute('data-addh');
            const add = parseInt(prompt('Horas a agregar:' )||'0',10);
            if (add>0) {
              const seg = loadJSON(uniKey('seguimiento'), []);
              const s = seg.find(x=>x.id===id);
              if (s){ s.horas = (s.horas||0) + add; saveJSON(uniKey('seguimiento'), seg); router(); }
            }
          }
          if (btnDel) {
            const id = btnDel.getAttribute('data-dels');
            if (!confirm('¿Eliminar seguimiento?')) return;
            const seg = loadJSON(uniKey('seguimiento'), []).filter(x=>x.id!==id);
            saveJSON(uniKey('seguimiento'), seg); router();
          }
          if (selSt) {
            const id = selSt.getAttribute('data-state');
            const seg = loadJSON(uniKey('seguimiento'), []);
            const s = seg.find(x=>x.id===id);
            if (s){ s.estado = selSt.value; saveJSON(uniKey('seguimiento'), seg); }
          }
        });
      }

      // CONVENIOS handlers
      if (hash === '#/convenios') {
        document.getElementById('btnAddConv').onclick = () => {
          const empresa = prompt('Empresa:'); if(!empresa) return;
          const tipo = prompt('Tipo de convenio (Marco/Específico):') || 'Marco';
          const desde = prompt('Desde (YYYY-MM-DD):') || '';
          const hasta = prompt('Hasta (YYYY-MM-DD):') || '';
          const vigente = confirm('¿Marcar como vigente?');
          const data = loadJSON(uniKey('convenios'), []);
          data.unshift({ id: crypto.randomUUID?.()||String(Date.now()), empresa, tipo, desde, hasta, vigente });
          saveJSON(uniKey('convenios'), data); router();
        };
        const tbody = app.querySelector('tbody');
        tbody?.addEventListener('click', (e) => {
          const btnT = e.target.closest('button[data-togglec]');
          const btnD = e.target.closest('button[data-delc]');
          if (btnT) {
            const id = btnT.getAttribute('data-togglec');
            const data = loadJSON(uniKey('convenios'), []);
            const c = data.find(x=>x.id===id);
            if (c){ c.vigente = !c.vigente; saveJSON(uniKey('convenios'), data); router(); }
          }
          if (btnD) {
            const id = btnD.getAttribute('data-delc');
            if(!confirm('¿Eliminar convenio?')) return;
            const data = loadJSON(uniKey('convenios'), []).filter(x=>x.id!==id);
            saveJSON(uniKey('convenios'), data); router();
          }
        });
      }

      // PERFIL handlers
      if (hash === '#/perfil') {
        const inpNombreU = document.getElementById('inpNombreU');
        const inpEmailU  = document.getElementById('inpEmailU');
        const inpWebU    = document.getElementById('inpWebU');
        inpNombreU.value = window.usuario?.nombre || '';
        inpEmailU.value  = window.usuario?.email || '';
        inpWebU.value    = window.usuario?.web || '';

        document.getElementById('btnGuardarPerfilU').onclick = () => {
          const updated = {
            ...window.usuario,
            nombre: inpNombreU.value.trim(),
            email: inpEmailU.value.trim(),
            web: inpWebU.value.trim(),
          };
          localStorage.setItem('usuarioActivo', JSON.stringify(updated));
          window.usuario = updated;
          document.getElementById("navUniName").textContent = updated.nombre || '';
          document.getElementById("navUniEmail").textContent = updated.email || '';
          alert('Perfil actualizado ✔');
        };
        document.getElementById('btnCancelarPerfilU').onclick = () => router();

        document.getElementById('btnCambiarPass').onclick = (e) => {
          e.preventDefault();
          const p1 = document.getElementById('inpPass1').value;
          const p2 = document.getElementById('inpPass2').value;
          if (!p1 || p1 !== p2) { alert('Las contraseñas no coinciden'); return; }
          // Demo: guardamos en el usuario activo (no recomendado en producción)
          const updated = { ...window.usuario, password: p1 };
          localStorage.setItem('usuarioActivo', JSON.stringify(updated));
          window.usuario = updated;
          alert('Contraseña actualizada ✔');
        };
      }

      setActiveLink(hash);
      closeSidebarIfMobile();
    }

    // Abrir/cerrar modal de vacante
    const vacModal = document.getElementById('vacModal');
    const vacOverlay = document.getElementById('vacModalOverlay');
    const vacClose = document.getElementById('vacModalClose');
    const vacCancel = document.getElementById('vacModalCancel');
    const vacSave = document.getElementById('vacModalSave');
    const vacTitle = document.getElementById('vacModalTitle');

    function openVacModal(v){
      vacTitle.textContent = v ? 'Editar vacante' : 'Nueva vacante';
      document.getElementById('vacCargo').value = v?.cargo || '';
      document.getElementById('vacEmpresa').value = v?.empresa || '';
      document.getElementById('vacCiudad').value = v?.ciudad || '';
      document.getElementById('vacModalidad').value = v?.modalidad || 'Presencial';
      document.getElementById('vacCarreras').value = (v?.carreras||[]).join(', ');
      document.getElementById('vacTags').value = (v?.tags||[]).join(', ');
      document.getElementById('vacDesc').value = v?.desc || '';
      document.getElementById('vacEditId').value = v?.id || '';
      vacModal.classList.remove('hidden');
    }
    function closeVacModal(){ vacModal.classList.add('hidden'); }
    vacOverlay.addEventListener('click', closeVacModal);
    vacClose.addEventListener('click', closeVacModal);
    vacCancel.addEventListener('click', closeVacModal);

    vacSave.addEventListener('click', () => {
      const payload = {
        cargo: document.getElementById('vacCargo').value.trim(),
        empresa: document.getElementById('vacEmpresa').value.trim(),
        ciudad: document.getElementById('vacCiudad').value.trim(),
        modalidad: document.getElementById('vacModalidad').value,
        carreras: document.getElementById('vacCarreras').value.split(',').map(s=>s.trim()).filter(Boolean),
        tags: document.getElementById('vacTags').value.split(',').map(s=>s.trim()).filter(Boolean),
        desc: document.getElementById('vacDesc').value.trim()
      };
      if (!payload.cargo || !payload.empresa) { alert('Cargo y empresa son obligatorios'); return; }
      const idEdit = document.getElementById('vacEditId').value;
      const vac = loadJSON(uniKey('vacantes'), []);
      if (idEdit) {
        const v = vac.find(x=>x.id===idEdit);
        if (v) Object.assign(v, payload);
      } else {
        vac.unshift({ id: crypto.randomUUID?.()||String(Date.now()), ...payload, estado:'Activa', fecha: Date.now() });
      }
      saveJSON(uniKey('vacantes'), vac);
      closeVacModal();
      if (location.hash === '#/vacantes') router();
    });

    // Export CSV seguimiento
    function exportSeguimientoCSV(){
      const seg = loadJSON(uniKey('seguimiento'), []);
      const cols = ['Estudiante','Carrera','Empresa','Cargo','Estado','Horas','MetaHoras','Tutor','Inicio','Fin'];
      const rows = seg.map(s => [s.estudiante,s.carrera,s.empresa,s.cargo,s.estado,s.horas,s.metaHoras,s.tutor,s.inicio,s.fin]);
      const csv = [cols.join(','), ...rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(','))].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'seguimiento.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // SideNav: cerrar drawer en móvil al navegar
    sideNav.addEventListener('click', (e) => {
      const a = e.target.closest('a[data-route]');
      if (a && window.matchMedia("(max-width: 767px)").matches) closeSidebar();
    });

    // Logout
    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem("usuarioActivo");
      window.location.href = "login.html";
    });

    window.addEventListener('hashchange', router);
    window.addEventListener('load', () => {
      if (!location.hash) location.hash = '#/inicio';
      router();
    });
  </script>
</body>
</html>
